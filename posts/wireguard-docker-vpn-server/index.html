<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Running WireGuard as Client and Server in Docker with PiHole and Traefik &#183; Learn Something New</title><meta name=title content="Running WireGuard as Client and Server in Docker with PiHole and Traefik &#183; Learn Something New"><meta name=description content="How to extend the WireGuard Docker container to act as both a VPN client and server, with PiHole for DNS, Traefik as a reverse proxy, and services that bypass the kill switch."><meta name=keywords content="Docker,WireGuard,VPN,PiHole,Traefik,ntfy,"><link rel=canonical href=https://jmartins.dev/posts/wireguard-docker-vpn-server/><meta name=author content="João M. Martins"><link href=https://github.com/joaommartins rel=me><link href=https://codeberg.org/joaommartins rel=me><link href=https://linkedin.com/in/joaommartins rel=me><meta property="og:url" content="https://jmartins.dev/posts/wireguard-docker-vpn-server/"><meta property="og:site_name" content="Learn Something New"><meta property="og:title" content="Running WireGuard as Client and Server in Docker with PiHole and Traefik"><meta property="og:description" content="How to extend the WireGuard Docker container to act as both a VPN client and server, with PiHole for DNS, Traefik as a reverse proxy, and services that bypass the kill switch."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-23T10:00:00+00:00"><meta property="article:modified_time" content="2026-02-23T10:00:00+00:00"><meta property="article:tag" content="Docker"><meta property="article:tag" content="WireGuard"><meta property="article:tag" content="VPN"><meta property="article:tag" content="PiHole"><meta property="article:tag" content="Traefik"><meta property="article:tag" content="Ntfy"><meta name=twitter:card content="summary"><meta name=twitter:title content="Running WireGuard as Client and Server in Docker with PiHole and Traefik"><meta name=twitter:description content="How to extend the WireGuard Docker container to act as both a VPN client and server, with PiHole for DNS, Traefik as a reverse proxy, and services that bypass the kill switch."><link type=text/css rel=stylesheet href=/css/main.bundle.min.0ec50faaff63517457b42cd1ae620d2433e39623be62a0452d34cea993bf4c0ed26d8af5ba55b37c054906db11315ffd70f888bae24711e0afad2c717aa81650.css integrity="sha512-DsUPqv9jUXRXtCzRrmINJDPjliO+YqBFLTTOqZO/TA7SbYr1ulWzfAVJBtsRMV/9cPiIuuJHEeCvrSxxeqgWUA=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.858f7f82734cfae08d59fcf8d0eb186f01706a84e2f7d20d39edfd7bc8bed6166e02d5c65ecce1de82b1ac52d1e01d77bd1a82d19186fdae5fe6e12d867fcf68.js integrity="sha512-hY9/gnNM+uCNWfz40OsYbwFwaoTi99INOe39e8i+1hZuAtXGXszh3oKxrFLR4B13vRqC0ZGG/a5f5uEthn/PaA==" data-copy=Copy data-copied=Copied></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"Running WireGuard as Client and Server in Docker with PiHole and Traefik","headline":"Running WireGuard as Client and Server in Docker with PiHole and Traefik","description":"How to extend the WireGuard Docker container to act as both a VPN client and server, with PiHole for DNS, Traefik as a reverse proxy, and services that bypass the kill switch.","inLanguage":"en","url":"https://jmartins.dev/posts/wireguard-docker-vpn-server/","author":{"@type":"Person","name":"João M. Martins"},"copyrightYear":"2026","dateCreated":"2026-02-23T10:00:00\u002b00:00","datePublished":"2026-02-23T10:00:00\u002b00:00","dateModified":"2026-02-23T10:00:00\u002b00:00","keywords":["Docker","WireGuard","VPN","PiHole","Traefik","ntfy"],"mainEntityOfPage":"true","wordCount":"4683"}]</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><a href=/ class="text-base font-medium truncate min-w-0 shrink">Learn Something New</a><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/about/ class="flex items-center bf-icon-color-hover" aria-label=About title><span class="text-base font-medium break-normal">About
</span></a><a href=/posts/ class="flex items-center bf-icon-color-hover" aria-label=Blog title><span class="text-base font-medium break-normal">Blog
</span></a><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base bf-icon-color-hover"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile type=button aria-label="Dark mode switcher" class="flex items-center justify-center text-neutral-900 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400"><div class=dark:hidden><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="hidden dark:block"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/about/ aria-label=About class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title class="text-2xl font-bold tracking-tight">About</span></a></div><div class=px-2><a href=/posts/ aria-label=Blog class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title class="text-2xl font-bold tracking-tight">Blog</span></a></div></nav></div></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Running WireGuard as Client and Server in Docker with PiHole and Traefik</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2026-02-23T10:00:00+00:00>23 February 2026</time><span class="px-2 text-primary-500">&#183;</span><span>4683 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">22 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#the-architecture>The Architecture</a></li><li><a href=#two-interfaces-one-container>Two Interfaces, One Container</a><ul><li><a href=#the-server-interface>The Server Interface</a></li><li><a href=#the-client-interface>The Client Interface</a></li></ul></li><li><a href=#the-updated-kill-switch>The Updated Kill Switch</a></li><li><a href=#pihole-dns-for-the-stack-and-beyond>PiHole: DNS for the Stack and Beyond</a><ul><li><a href=#note-on-pihole-healthcheck>Note on PiHole healthcheck</a></li></ul></li><li><a href=#traefik-the-reverse-proxy>Traefik: The Reverse Proxy</a><ul><li><a href=#docker-socket-proxy>Docker Socket Proxy</a></li><li><a href=#the-traefik-service>The Traefik Service</a></li><li><a href=#service-routing-with-labels>Service Routing with Labels</a></li><li><a href=#services-outside-the-kill-switch>Services Outside the Kill Switch</a></li></ul></li><li><a href=#putting-it-all-together>Putting It All Together</a></li><li><a href=#connecting-from-the-outside>Connecting from the Outside</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#changelog>Changelog</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#the-architecture>The Architecture</a></li><li><a href=#two-interfaces-one-container>Two Interfaces, One Container</a><ul><li><a href=#the-server-interface>The Server Interface</a></li><li><a href=#the-client-interface>The Client Interface</a></li></ul></li><li><a href=#the-updated-kill-switch>The Updated Kill Switch</a></li><li><a href=#pihole-dns-for-the-stack-and-beyond>PiHole: DNS for the Stack and Beyond</a><ul><li><a href=#note-on-pihole-healthcheck>Note on PiHole healthcheck</a></li></ul></li><li><a href=#traefik-the-reverse-proxy>Traefik: The Reverse Proxy</a><ul><li><a href=#docker-socket-proxy>Docker Socket Proxy</a></li><li><a href=#the-traefik-service>The Traefik Service</a></li><li><a href=#service-routing-with-labels>Service Routing with Labels</a></li><li><a href=#services-outside-the-kill-switch>Services Outside the Kill Switch</a></li></ul></li><li><a href=#putting-it-all-together>Putting It All Together</a></li><li><a href=#connecting-from-the-outside>Connecting from the Outside</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#changelog>Changelog</a></li></ul></nav></div></details><script>(function(){"use strict";const s=.33,o="#TableOfContents",i=".anchor",a='a[href^="#"]',r="li ul",c="active";let t=!1;function l(e,n){const o=window.scrollY+window.innerHeight*n,i=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],s=new Set(i.map(e=>e.getAttribute("href").substring(1)));if(t)for(let t=0;t<e.length;t++){const n=e[t];if(!s.has(n.id))continue;const o=n.getBoundingClientRect().top+window.scrollY;if(Math.abs(window.scrollY-o)<100)return n.id}for(let t=e.length-1;t>=0;t--){const n=e[t].getBoundingClientRect().top+window.scrollY;if(n<=o&&s.has(e[t].id))return e[t].id}return e.find(e=>s.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=l(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(c,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function n(){const n=document.querySelector(o);if(!n)return;const l=!0,u=[...document.querySelectorAll(i)],d=[...n.querySelectorAll(a)];l&&n.querySelectorAll(r).forEach(e=>e.style.display="none"),d.forEach(e=>{e.addEventListener("click",()=>{t=!0})});const c={toc:n,anchors:u,links:d,scrollOffset:s,collapseInactive:l};window.addEventListener("scroll",()=>e(c),{passive:!0}),window.addEventListener("hashchange",()=>e(c),{passive:!0}),e(c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><blockquote><p><strong>TL;DR</strong> If you want to skip straight to the goods, the GitHub repository from the previous article has been updated
with the full client-server configuration, PiHole and Traefik setup:
<a href=https://github.com/joaommartins/wireguard-network-stack target=_blank rel=noreferrer>here</a>.</p></blockquote><p>If you&rsquo;ve read the <a href=/posts/wireguard-docker-killswitch/>previous article</a>, you&rsquo;ll know that I promised a follow-up
covering the evolution of my WireGuard Docker stack. What started as a single VPN client container with a kill switch
has since grown into something more ambitious: a single WireGuard container acting as both a Mullvad VPN client <em>and</em>
a WireGuard server, with PiHole handling DNS for every device on the network and Traefik managing HTTPS reverse proxying
for all self-hosted services. That&rsquo;s a lot happening in one container&rsquo;s network namespace, but it works well and is
straightforward to configure once you understand how the pieces fit together.</p><p>The goal is straightforward: connect my devices to my home server from anywhere in the world, access all self-hosted
services over HTTPS with valid certificates, have PiHole block ads on every connected device, and have all outbound
traffic exit through Mullvad VPN. If the VPN connection drops, nothing gets through. <em>Fail closed</em>, as we discussed in
the previous article.</p><h2 class="relative group">The Architecture<div id=the-architecture class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-architecture aria-label=Anchor>#</a></span></h2><p>Before diving into configuration files, let me outline what we&rsquo;re building. The WireGuard container sits at the centre
of everything. It runs two WireGuard interfaces simultaneously: <code>wg0</code> acts as the server, accepting connections from
remote clients like my laptop and phone, while <code>wg1</code> acts as the VPN client, tunnelling outbound traffic through
Mullvad. PiHole and Traefik both run on the WireGuard container&rsquo;s network stack using Docker&rsquo;s
<code>network_mode: service:wireguard</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, meaning they share its network interfaces — including both WireGuard
tunnels.</p><p>When a remote client connects via WireGuard, their traffic enters through <code>wg0</code>, gets forwarded through the container,
and exits via <code>wg1</code> to Mullvad. DNS queries go to PiHole (running on the tunnel IP), which blocks ads and resolves
<code>*.jmartins.dev</code> to the tunnel address where Traefik is listening. Traefik then routes the request to the correct
service based on the hostname. All of this happens without any service being directly exposed to the internet.</p><h2 class="relative group">Two Interfaces, One Container<div id=two-interfaces-one-container class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#two-interfaces-one-container aria-label=Anchor>#</a></span></h2><p>In the <a href=/posts/wireguard-docker-killswitch/>previous article</a>, our WireGuard container ran a single interface (<code>wg0</code>)
as a Mullvad VPN client. Now we need two: a server interface for accepting remote connections and a client interface
for the outbound VPN tunnel. The Linuxserver.io WireGuard image makes this relatively painless.</p><h3 class="relative group">The Server Interface<div id=the-server-interface class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-server-interface aria-label=Anchor>#</a></span></h3><p>Setting the <code>PEERS</code> environment variable on the Linuxserver.io WireGuard container triggers its server
mode<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. The image generates a server configuration and individual peer configurations that can
be imported on your devices.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>### DOCKER-COMPOSE.YAML — WIREGUARD SERVICE (PARTIAL) ###</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>wireguard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>lscr.io/linuxserver/wireguard:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cap_add</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET_ADMIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PUID=${PUID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PGID=${PGID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=${TZ}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PEERS=laptop,phone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SERVERURL=wireguard.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SERVERPORT=${WIREGUARD_PORT}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>INTERNAL_SUBNET=10.0.2.0/24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PEERDNS=10.0.2.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>ALLOWEDIPS=0.0.0.0/0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>LOG_CONFS=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/wireguard:/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/wireguard_startup:/custom-cont-init.d:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>80</span><span class=p>:</span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>443</span><span class=p>:</span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${WIREGUARD_PORT}:${WIREGUARD_PORT}/udp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sysctls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>net.ipv4.conf.all.src_valid_mark=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=l>ping -c 1 1.1.1.1 || exit 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_interval</span><span class=p>:</span><span class=w> </span><span class=l>2s </span><span class=w> </span><span class=c># requires Docker Compose v2.20+ / Docker Engine 25+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span></span></span></code></pre></div></div><p>A few things stand out compared to the previous article. We&rsquo;re now exposing the WireGuard port (UDP only — WireGuard
doesn&rsquo;t use TCP) for incoming peer connections, as well as ports 80 and 443 for the web services we&rsquo;ll be routing
through Traefik later. The <code>PEERDNS</code>
variable tells the generated peer configurations to use <code>10.0.2.1</code> as their DNS server — this will be PiHole, running
on the WireGuard container&rsquo;s network stack at the server&rsquo;s tunnel address. <code>ALLOWEDIPS=0.0.0.0/0</code> means the generated
peer configs will route <em>all</em> client traffic through the tunnel, not just traffic destined for the server&rsquo;s subnet.
<code>LOG_CONFS=false</code> prevents the image from logging the generated configurations to the container output, which you
probably want when your private keys are involved.</p><p>On first run, the image generates a server configuration in <code>/config/wg_confs/wg0.conf</code> along with peer configurations
in <code>/config/peer_laptop/</code>, <code>/config/peer_phone/</code>, and so on. The generated config needs forwarding and NAT rules to
route peer traffic through the Mullvad tunnel. Rather than editing <code>wg0.conf</code> by hand every time the image regenerates
it, our startup script (covered below) patches it automatically. The result looks like this:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.0.2.1</span>
</span></span><span class=line><span class=cl><span class=na>ListenPort</span> <span class=o>=</span> <span class=s>51820</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>[REDACTED]</span>
</span></span><span class=line><span class=cl><span class=na>PostUp</span> <span class=o>=</span> <span class=s>iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o wg1 -j MASQUERADE; iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eth0 -j MASQUERADE</span>
</span></span><span class=line><span class=cl><span class=na>FwMark</span> <span class=o>=</span> <span class=s>51820</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>[Peer] # peer_laptop</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>[REDACTED]</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.0.2.2/32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>[Peer] # peer_phone</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>[REDACTED]</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>10.0.2.3/32</span></span></span></code></pre></div></div><p>The <code>PostUp</code> directive is the key to the dual-interface setup. When the server interface comes up, it:</p><ol><li>Allows packet forwarding in both directions through <code>wg0</code>, so traffic from peers can be routed through the container.</li><li>Masquerades all traffic leaving through <code>wg1</code> (the Mullvad tunnel), so peers&rsquo; outbound internet traffic appears to
originate from the container&rsquo;s Mullvad VPN address.</li><li>Masquerades traffic from the WireGuard subnet (<code>10.0.2.0/24</code>) leaving through <code>eth0</code> (the Docker bridge interface),
so peers can reach services on the local network and other Docker containers.</li></ol><p>The <code>FwMark = 51820</code> is critical — it marks the server&rsquo;s own encrypted UDP packets with this value. As we&rsquo;ll see when
we update the kill switch, these marked packets are exempt from the outbound blocking rules, allowing the server to
communicate with its remote peers regardless of the state of the Mullvad connection.</p><p>You&rsquo;ll notice there&rsquo;s no corresponding <code>PostDown</code> directive to clean up these iptables rules. In a Docker context this
is fine — restarting the interface means restarting the entire container, which resets iptables state. If you adapt this
setup for a non-containerised host, you&rsquo;ll want to add <code>PostDown</code> rules that mirror the <code>PostUp</code> with <code>-D</code> (delete)
instead of <code>-A</code> (append) to avoid accumulating duplicate rules on interface restarts.</p><h3 class="relative group">The Client Interface<div id=the-client-interface class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-client-interface aria-label=Anchor>#</a></span></h3><p>The Mullvad VPN client configuration from the previous article is now <code>wg1.conf</code> instead of <code>wg0.conf</code>, placed directly
in the <code>/config</code> directory. The configuration is largely the same, with one important change:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>[REDACTED]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.64.114.74/32</span>
</span></span><span class=line><span class=cl><span class=na>DNS</span> <span class=o>=</span> <span class=s>127.0.0.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>[REDACTED]</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>0.0.0.0/0</span>
</span></span><span class=line><span class=cl><span class=na>Endpoint</span> <span class=o>=</span> <span class=s>89.44.10.178:51820</span></span></span></code></pre></div></div><p>The <code>DNS</code> field now points to <code>127.0.0.1</code> instead of Mullvad&rsquo;s DNS server. Since PiHole runs on the WireGuard
container&rsquo;s network stack, <code>localhost</code> resolves to PiHole. This means even the container&rsquo;s own DNS queries go through
PiHole, getting the benefit of ad blocking and our custom domain resolution.</p><p>There&rsquo;s a subtlety here: <code>wg-quick up</code> sets <code>127.0.0.1</code> as the system resolver when it brings up <code>wg1</code>, but PiHole
hasn&rsquo;t started yet at this point (it depends on the WireGuard container being healthy first). This creates a brief
window where DNS is unavailable inside the container. In practice this doesn&rsquo;t matter — the healthcheck uses an IP
address (<code>ping -c 1 1.1.1.1</code>), and the dependency chain ensures no service that needs DNS starts until PiHole is up.
Just be aware of this if you modify the startup order.</p><p>We&rsquo;ve also removed the <code>PostUp</code> kill switch directive from the client config. As we discussed in the previous article,
relying on the WireGuard configuration file for the kill switch means a parsing error could leave us in a <em>fail open</em>
state. We&rsquo;ll continue handling the kill switch in the startup script instead.</p><h2 class="relative group">The Updated Kill Switch<div id=the-updated-kill-switch class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-updated-kill-switch aria-label=Anchor>#</a></span></h2><p>With two WireGuard interfaces, the startup script from the previous article needs updating. The kill switch now targets
<code>wg1</code> (the Mullvad tunnel) instead of <code>wg0</code>, and we need to handle the client connection startup ourselves since the
Linuxserver.io image only manages the server interface automatically.</p><p>The script also has a new responsibility: patching the generated <code>wg0.conf</code> with the custom <code>PostUp</code> and <code>FwMark</code>
directives described above. The Linuxserver.io image regenerates <code>wg0.conf</code> with a default <code>PostUp</code> that only covers
basic forwarding — it doesn&rsquo;t know about our Mullvad tunnel or LAN access requirements. Rather than manually editing
the config after each regeneration, the script handles it idempotently on every startup.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Patch wg0.conf with forwarding, NAT, and FwMark if not already present.</span>
</span></span><span class=line><span class=cl><span class=c1># The Linuxserver.io image generates a bare wg0.conf with a default PostUp</span>
</span></span><span class=line><span class=cl><span class=c1># that only covers basic forwarding. The dual-interface (client+server) setup</span>
</span></span><span class=line><span class=cl><span class=c1># needs custom rules for routing through wg1 (Mullvad) and LAN access.</span>
</span></span><span class=line><span class=cl><span class=nv>WG0_CONF</span><span class=o>=</span><span class=s2>&#34;/config/wg_confs/wg0.conf&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>POSTUP</span><span class=o>=</span><span class=s1>&#39;PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o wg1 -j MASQUERADE; iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eth0 -j MASQUERADE&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$WG0_CONF</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># Check if our custom PostUp is present (look for wg1 masquerade specifically)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> grep -q <span class=s2>&#34;POSTROUTING -o wg1&#34;</span> <span class=s2>&#34;</span><span class=nv>$WG0_CONF</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;**** wg0.conf: custom PostUp already present ****&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> grep -q <span class=s2>&#34;^PostUp&#34;</span> <span class=s2>&#34;</span><span class=nv>$WG0_CONF</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=c1># Default PostUp exists but missing our custom rules — replace it</span>
</span></span><span class=line><span class=cl>        sed -i <span class=s2>&#34;s|^PostUp.*|</span><span class=nv>$POSTUP</span><span class=s2>|&#34;</span> <span class=s2>&#34;</span><span class=nv>$WG0_CONF</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;**** Patched wg0.conf: replaced default PostUp with custom rules ****&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=c1># No PostUp at all — insert after PrivateKey</span>
</span></span><span class=line><span class=cl>        sed -i <span class=s2>&#34;/^PrivateKey/a\\</span><span class=nv>$POSTUP</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$WG0_CONF</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;**** Patched wg0.conf: added PostUp ****&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> ! grep -q <span class=s2>&#34;^FwMark&#34;</span> <span class=s2>&#34;</span><span class=nv>$WG0_CONF</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        sed -i <span class=s2>&#34;/^PostUp/a\\FwMark = 51820&#34;</span> <span class=s2>&#34;</span><span class=nv>$WG0_CONF</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;**** Patched wg0.conf: added FwMark ****&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;**** Adding iptables rules ****&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>DROUTE</span><span class=o>=</span><span class=k>$(</span>ip route <span class=p>|</span> grep default <span class=p>|</span> awk <span class=s1>&#39;{print $3}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>HOMENET</span><span class=o>=</span>192.168.0.0/16
</span></span><span class=line><span class=cl><span class=nv>HOMENET2</span><span class=o>=</span>10.0.0.0/8
</span></span><span class=line><span class=cl><span class=nv>HOMENET3</span><span class=o>=</span>172.16.0.0/12
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Add routes for private networks (tolerant of pre-existing routes)</span>
</span></span><span class=line><span class=cl>ip route add <span class=nv>$HOMENET3</span> via <span class=nv>$DROUTE</span> 2&gt;/dev/null <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip route add <span class=nv>$HOMENET2</span> via <span class=nv>$DROUTE</span> 2&gt;/dev/null <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip route add <span class=nv>$HOMENET</span>  via <span class=nv>$DROUTE</span> 2&gt;/dev/null <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow traffic to private networks</span>
</span></span><span class=line><span class=cl>iptables -I OUTPUT -d <span class=nv>$HOMENET</span>  -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A OUTPUT -d <span class=nv>$HOMENET2</span> -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A OUTPUT -d <span class=nv>$HOMENET3</span> -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Kill switch</span>
</span></span><span class=line><span class=cl>iptables -A OUTPUT ! -o wg1 -m mark ! --mark 0xca6c -m addrtype ! --dst-type LOCAL -j REJECT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>wg-quick up /config/wg1.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;**** Successfully added iptables rules ****&#34;</span></span></span></code></pre></div></div><p>This script runs during container initialisation, before either WireGuard interface is brought
up<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. Compared to the script from the previous article, there are four important changes:</p><ol><li><p><strong>Automatic <code>wg0.conf</code> patching</strong>: The script checks whether the generated server config already has our custom
<code>PostUp</code> and <code>FwMark</code> directives. If the image has regenerated a default config, the script replaces the <code>PostUp</code>
line and adds <code>FwMark</code>. The check is idempotent — if the custom rules are already present, it does nothing. This
means you never need to manually edit the generated config, even after adding or removing peers.</p></li><li><p><strong>Local network routes</strong>: We add explicit routes for RFC 1918<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> private address ranges via the container&rsquo;s
default gateway. Without these, traffic destined for the Docker networks and your home network would attempt to route
through the VPN tunnel. The corresponding <code>iptables</code> rules ensure that outbound traffic to these subnets is always
allowed, regardless of the kill switch state. The route additions are tolerant of pre-existing entries — on a
container restart, these routes may already exist, so the script suppresses the error rather than failing.</p></li><li><p><strong>Kill switch targeting <code>wg1</code></strong>: The kill switch rule now references <code>wg1</code> instead of <code>wg0</code>. It rejects all outbound
traffic that is <em>not</em> going through the Mullvad tunnel, <em>not</em> marked with <code>0xca6c</code> (the hexadecimal representation
of port 51820), and <em>not</em> destined for a local address. The <code>FwMark = 51820</code> we set on the server interface ensures
its encrypted packets to remote peers are marked and thus exempted — without this, the server wouldn&rsquo;t be able to
communicate with its clients.</p></li><li><p><strong>Manual client startup</strong>: We bring up <code>wg1</code> ourselves with <code>wg-quick up</code>. The Linuxserver.io image handles <code>wg0</code>
(the server), but since <code>wg1</code> is our custom addition, we need to start it explicitly.</p></li></ol><p>The execution order is then:</p><ol><li>Container starts, startup script runs.</li><li><code>wg0.conf</code> is patched with custom <code>PostUp</code> and <code>FwMark</code> (if needed).</li><li>Kill switch and local network rules are set — outbound internet traffic is now <em>blocked</em>.</li><li><code>wg1</code> (Mullvad client) is brought up — outbound traffic through the VPN is now <em>allowed</em>.</li><li>Linuxserver.io image brings up <code>wg0</code> (server) with our patched config — remote peers can now connect.</li></ol><p>If the startup script fails or the Mullvad connection cannot be established, the kill switch is already in place. <em>Fail closed.</em></p><h2 class="relative group">PiHole: DNS for the Stack and Beyond<div id=pihole-dns-for-the-stack-and-beyond class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#pihole-dns-for-the-stack-and-beyond aria-label=Anchor>#</a></span></h2><p>PiHole<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup> needs no introduction to the self-hosting crowd, but its role in this stack goes beyond blocking ads.
By running PiHole on the WireGuard container&rsquo;s network stack, it becomes the DNS server for both local containers <em>and</em>
remote WireGuard peers.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>### DOCKER-COMPOSE.YAML — PIHOLE SERVICE ###</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pihole</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>pihole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>pihole/pihole:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=l>service:wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>wireguard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>service_healthy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=l>ping -c 1 google.com || exit 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_interval</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>TZ</span><span class=p>:</span><span class=w> </span><span class=l>${TZ}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_webserver_port</span><span class=p>:</span><span class=w> </span><span class=l>${PIHOLE_WEBUI_PORT}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_webserver_api_password</span><span class=p>:</span><span class=w> </span><span class=l>${PIHOLE_PASSWORD}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_dns_upstreams</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;1.1.1.1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_dns_dnssec</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_dns_revServers</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;true,192.168.1.0/24,192.168.1.1,lan&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_misc_dnsmasq_lines</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;address=/jmartins.dev/10.0.2.1;server=/proxy/127.0.0.11&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cap_add</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET_ADMIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/pihole/etc-pihole/:/etc/pihole/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/pihole/etc-dnsmasq.d/:/etc/dnsmasq.d/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span></span></span></code></pre></div></div><p>The <code>network_mode: service:wireguard</code> directive means PiHole shares the WireGuard container&rsquo;s entire network namespace
— all its interfaces, IP addresses, and routing tables. Since the WireGuard server&rsquo;s tunnel address is <code>10.0.2.1</code>,
PiHole is reachable at <code>10.0.2.1:53</code> from any connected peer.</p><p>The important line here is:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>FTLCONF_misc_dnsmasq_lines: &#34;address=/jmartins.dev/10.0.2.1;server=/proxy/127.0.0.11&#34;</span></span></code></pre></div></div><p>This packs two dnsmasq directives into a single environment variable, separated by a semicolon:</p><ol><li><p><code>address=/jmartins.dev/10.0.2.1</code> tells PiHole to resolve <em>any</em> subdomain of <code>jmartins.dev</code> to <code>10.0.2.1</code>. So when
a remote client&rsquo;s browser requests <code>jellyfin.jmartins.dev</code>, PiHole responds with <code>10.0.2.1</code> — the WireGuard tunnel
address where Traefik is listening. The request stays inside the tunnel the entire way.</p></li><li><p><code>server=/proxy/127.0.0.11</code> is a conditional DNS forward. When <code>wg-quick</code> brings up the Mullvad client, it overwrites
<code>/etc/resolv.conf</code> inside the container to point at <code>127.0.0.1</code> (PiHole). That&rsquo;s fine for external domains, but
Traefik needs to resolve the hostname <code>proxy</code> to reach the Docker Socket Proxy at <code>tcp://proxy:2375</code>. PiHole doesn&rsquo;t
know about Docker container names — only Docker&rsquo;s embedded DNS at <code>127.0.0.11</code> does. This directive tells dnsmasq to
forward queries for <code>proxy</code> specifically to Docker&rsquo;s DNS resolver, while everything else continues through the normal
upstream. No DNS leak, no broad forwarding — just the one hostname Traefik needs.</p></li></ol><p>Upstream DNS is set to <code>1.1.1.1</code> (Cloudflare), with DNSSEC enabled for good measure. Since all outbound traffic from
the container exits through the Mullvad VPN, even these upstream DNS queries are encrypted and anonymised.</p><p>Remember that we set <code>PEERDNS=10.0.2.1</code> in the WireGuard container&rsquo;s environment. This means the auto-generated peer
configurations include <code>DNS = 10.0.2.1</code>, so every device that connects via WireGuard automatically uses PiHole. No
client-side configuration needed — your phone gets ad blocking the moment it connects to the VPN.</p><blockquote><h3 class="relative group">Note on PiHole healthcheck<div id=note-on-pihole-healthcheck class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#note-on-pihole-healthcheck aria-label=Anchor>#</a></span></h3><p>PiHole&rsquo;s healthcheck pings <code>google.com</code> rather than an IP address. This is intentional — it validates that both
the VPN connection <em>and</em> DNS resolution are working. Services that depend on PiHole
(<code>depends_on: pihole: condition: service_healthy</code>) won&rsquo;t start until DNS is fully operational, preventing a cascade
of failures from containers that can&rsquo;t resolve hostnames.</p></blockquote><h2 class="relative group">Traefik: The Reverse Proxy<div id=traefik-the-reverse-proxy class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#traefik-the-reverse-proxy aria-label=Anchor>#</a></span></h2><p>With DNS sorted, we need something to actually handle the HTTPS requests arriving at <code>10.0.2.1</code>. Enter
Traefik<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>, a reverse proxy that can automatically discover Docker services and route traffic based on labels.</p><h3 class="relative group">Docker Socket Proxy<div id=docker-socket-proxy class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#docker-socket-proxy aria-label=Anchor>#</a></span></h3><p>Before configuring Traefik, a brief detour on security. Traefik&rsquo;s Docker provider needs access to the Docker socket to
discover services, but mounting <code>/var/run/docker.sock</code> directly into a container exposes the full Docker API, which
effectively grants root-equivalent access to the host. If Traefik were ever compromised, the attacker would have
unrestricted control over every container and volume on the machine.</p><p>Instead, we use a Docker Socket Proxy<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup> that exposes only the specific Docker API endpoints Traefik
needs:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>### DOCKER-COMPOSE.YAML — DOCKER SOCKET PROXY ###</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>proxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>tecnativa/docker-socket-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>CONTAINERS=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SERVICES=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NETWORKS=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TASKS=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>IMAGES=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/run/docker.sock:/var/run/docker.sock:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>internal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span></span></span></code></pre></div></div><p>The proxy runs on a dedicated internal Docker network marked with <code>internal: true</code>, meaning containers on this network
cannot access the internet. Only containers explicitly connected to the internal network can reach the proxy. We&rsquo;ll need
the WireGuard container connected to both the default and internal networks so that Traefik (running on its network
stack) can reach the proxy by its container hostname.</p><h3 class="relative group">The Traefik Service<div id=the-traefik-service class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-traefik-service aria-label=Anchor>#</a></span></h3><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>### DOCKER-COMPOSE.YAML — TRAEFIK SERVICE ###</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>traefik</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=l>service:wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/traefik/letsencrypt:/letsencrypt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>api.dashboard=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># LetsEncrypt with Cloudflare DNS challenge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>certificatesresolvers.letsencrypt.acme.dnschallenge=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>certificatesresolvers.letsencrypt.acme.email=me@example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Entrypoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.web.address=:80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.websecure.address=:443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.web.http.redirections.entryPoint.to=websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.web.http.redirections.entryPoint.scheme=https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Docker provider via socket proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>providers.docker=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>providers.docker.exposedbydefault=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>providers.docker.endpoint=tcp://proxy:2375</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Wildcard TLS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.websecure.http.tls=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.websecure.http.tls.certResolver=letsencrypt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.websecure.http.tls.domains[0].main=jmartins.dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.websecure.http.tls.domains[0].sans=*.jmartins.dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>log.level=INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>CF_DNS_API_TOKEN=[REDACTED]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pihole</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>service_healthy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>proxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>service_started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span></span></span></code></pre></div></div><p>A few details worth calling out:</p><p><strong>DNS challenge for Let&rsquo;s Encrypt</strong>: Since our services are only accessible through the WireGuard tunnel, the standard
HTTP-01 challenge won&rsquo;t work — Let&rsquo;s Encrypt can&rsquo;t reach our server over the public internet to validate ownership. We
use the DNS-01 challenge<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup> with Cloudflare as the DNS provider instead. Traefik automatically creates the
necessary DNS TXT records to prove domain ownership and obtains a wildcard certificate for <code>*.jmartins.dev</code>.</p><p><strong>Wildcard certificate</strong>: Rather than requesting individual certificates for each subdomain, a single wildcard
certificate covers the lot. Adding a new service is as simple as adding a Traefik label with the right <code>Host()</code> rule
— no new certificate needed, no rate limit concerns.</p><p><strong>HTTP to HTTPS redirect</strong>: The <code>web</code> entrypoint on port 80 automatically redirects all traffic to <code>websecure</code> on port
443.</p><h3 class="relative group">Service Routing with Labels<div id=service-routing-with-labels class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#service-routing-with-labels aria-label=Anchor>#</a></span></h3><p>Since Traefik uses <code>network_mode: service:wireguard</code>, it shares the WireGuard container&rsquo;s network namespace. This means
that any service <em>also</em> sharing that network namespace (via <code>network_mode: service:wireguard</code>) is reachable from Traefik
at <code>localhost:&lt;port></code>. However, Traefik discovers services through Docker labels, and since these co-located services
don&rsquo;t have their own network identity from Docker&rsquo;s perspective, their routing labels need to go on the WireGuard
container:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>### LABELS ON THE WIREGUARD CONTAINER ###</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.enable=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>## PiHole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.pihole.entrypoints=websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.pihole.rule=Host(`pihole.jmartins.dev`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.pihole.service=pihole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.pihole.loadbalancer.server.scheme=http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.pihole.loadbalancer.server.port=${PIHOLE_WEBUI_PORT}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>## Jellyfin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.jellyfin.entrypoints=websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.jellyfin.rule=Host(`jellyfin.jmartins.dev`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.jellyfin.tls.certresolver=letsencrypt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.jellyfin.service=jellyfin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.jellyfin.loadbalancer.server.scheme=http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.jellyfin.loadbalancer.server.port=${JELLYFIN_WEBUI_PORT}</span></span></span></code></pre></div></div><p>Each block defines a router (matching on hostname) and a service (pointing to the correct port). The pattern repeats
for every service you want to expose — add a <code>Host()</code> rule, point it at the right port, and Traefik handles the rest.
Services that have their <em>own</em> Docker network (not using <code>network_mode: service:wireguard</code>) can define labels directly
on their own container definitions instead.</p><h3 class="relative group">Services Outside the Kill Switch<div id=services-outside-the-kill-switch class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#services-outside-the-kill-switch aria-label=Anchor>#</a></span></h3><p>Not every service belongs behind the kill switch. Consider a notification service like ntfy<sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup> — its entire purpose
is to send push notifications to your devices. If the VPN connection drops and the kill switch activates, a
notification service sharing the WireGuard network would be blocked from reaching the internet along with everything
else. That&rsquo;s precisely the moment you <em>want</em> a notification telling you that egress has stopped.</p><p>The solution is to give the service its own Docker network identity instead of sharing WireGuard&rsquo;s. Since it&rsquo;s not using
<code>network_mode: service:wireguard</code>, it has its own outbound route that bypasses the kill switch entirely. Traefik can
still route to it — the Docker provider discovers it by its own labels, and the WireGuard container&rsquo;s connection to the
default Docker network means Traefik can reach it over that network.</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>### DOCKER-COMPOSE.YAML — NTFY SERVICE ###</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ntfy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>binwiederhier/ntfy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>ntfy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>serve</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=${TZ}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NTFY_BASE_URL=https://ntfy.jmartins.dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NTFY_AUTH_DEFAULT_ACCESS=deny-all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NTFY_BEHIND_PROXY=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NTFY_ENABLE_LOGIN=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>${PUID}:${PGID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/ntfy_cache:/var/lib/ntfy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/ntfy_config:/etc/ntfy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;CMD-SHELL&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;wget -q --tries=1 http://localhost:80/v1/health -O - | grep -Eo &#39;\&#34;healthy\&#34;\\s*:\\s*true&#39; || exit 1&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>60s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class=l>40s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.enable=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.ntfy.entrypoints=websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.ntfy.rule=Host(`ntfy.jmartins.dev`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.ntfy.tls.certresolver=letsencrypt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.ntfy.service=ntfy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.ntfy.loadbalancer.server.scheme=http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.ntfy.loadbalancer.server.port=80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span></span></span></code></pre></div></div><p>Notice the difference: the Traefik labels are on the <code>ntfy</code> container itself rather than on the <code>wireguard</code> container.
From a remote client&rsquo;s perspective the experience is
identical — <code>ntfy.jmartins.dev</code> resolves to <code>10.0.2.1</code> via PiHole, Traefik routes it to the ntfy container over the
Docker network, and the response travels back through the tunnel. The only difference is what happens to ntfy&rsquo;s
<em>outbound</em> traffic: it goes directly through the host&rsquo;s network rather than through Mullvad, so it can still deliver
notifications when the VPN is down.</p><p>This pattern applies to any service where continued outbound connectivity is more important than routing through the VPN
— monitoring, alerting, and dynamic DNS updaters are common examples.</p><h2 class="relative group">Putting It All Together<div id=putting-it-all-together class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#putting-it-all-together aria-label=Anchor>#</a></span></h2><p>Now we&rsquo;re ready to build the full stack. Here&rsquo;s the complete <code>docker-compose.yaml</code> with the WireGuard client-server,
PiHole, Traefik, the Docker Socket Proxy, Jellyfin as an example service behind the kill switch, and ntfy as an example
service outside it:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>### DOCKER-COMPOSE.YAML ###</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>wireguard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>lscr.io/linuxserver/wireguard:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cap_add</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET_ADMIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PUID=${PUID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PGID=${PGID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=${TZ}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PEERS=laptop,phone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SERVERURL=wireguard.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SERVERPORT=${WIREGUARD_PORT}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>INTERNAL_SUBNET=10.0.2.0/24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PEERDNS=10.0.2.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>ALLOWEDIPS=0.0.0.0/0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>LOG_CONFS=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=l>ping -c 1 1.1.1.1 || exit 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_interval</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/wireguard:/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/wireguard_startup:/custom-cont-init.d:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>80</span><span class=p>:</span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>443</span><span class=p>:</span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${WIREGUARD_PORT}:${WIREGUARD_PORT}/udp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${JELLYFIN_WEBUI_HTTP_PORT}:${JELLYFIN_WEBUI_HTTP_PORT} </span><span class=w> </span><span class=c># direct access for Jellyfin mobile apps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sysctls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>net.ipv4.conf.all.src_valid_mark=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>internal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.enable=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>## PiHole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.pihole.entrypoints=websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.pihole.rule=Host(`pihole.jmartins.dev`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.pihole.service=pihole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.pihole.loadbalancer.server.scheme=http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.pihole.loadbalancer.server.port=${PIHOLE_WEBUI_PORT}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>## Traefik dashboard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.traefik.entrypoints=websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.traefik.rule=Host(`traefik.jmartins.dev`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.traefik.tls.certresolver=letsencrypt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.traefik.service=api@internal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>## Jellyfin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.jellyfin.entrypoints=websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.jellyfin.rule=Host(`jellyfin.jmartins.dev`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.jellyfin.tls.certresolver=letsencrypt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.jellyfin.service=jellyfin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.jellyfin.loadbalancer.server.scheme=http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.jellyfin.loadbalancer.server.port=${JELLYFIN_WEBUI_HTTP_PORT}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pihole</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>pihole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>pihole/pihole:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=l>service:wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>wireguard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>service_healthy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=l>ping -c 1 google.com || exit 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_interval</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>TZ</span><span class=p>:</span><span class=w> </span><span class=l>${TZ}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_webserver_port</span><span class=p>:</span><span class=w> </span><span class=l>${PIHOLE_WEBUI_PORT}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_webserver_api_password</span><span class=p>:</span><span class=w> </span><span class=l>${PIHOLE_PASSWORD}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_dns_upstreams</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;1.1.1.1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_dns_dnssec</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_dns_revServers</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;true,192.168.1.0/24,192.168.1.1,lan&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>FTLCONF_misc_dnsmasq_lines</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;address=/jmartins.dev/10.0.2.1;server=/proxy/127.0.0.11&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cap_add</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET_ADMIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/pihole/etc-pihole/:/etc/pihole/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/pihole/etc-dnsmasq.d/:/etc/dnsmasq.d/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>proxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>tecnativa/docker-socket-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>CONTAINERS=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SERVICES=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NETWORKS=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TASKS=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>IMAGES=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/run/docker.sock:/var/run/docker.sock:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>internal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>traefik</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=l>service:wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/etc/localtime:/etc/localtime:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/traefik/letsencrypt:/letsencrypt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>api.dashboard=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>certificatesresolvers.letsencrypt.acme.dnschallenge=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>certificatesresolvers.letsencrypt.acme.email=me@example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.web.address=:80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.websecure.address=:443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.web.http.redirections.entryPoint.to=websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.web.http.redirections.entryPoint.scheme=https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>providers.docker=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>providers.docker.exposedbydefault=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>providers.docker.endpoint=tcp://proxy:2375</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.websecure.http.tls=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.websecure.http.tls.certResolver=letsencrypt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.websecure.http.tls.domains[0].main=jmartins.dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>entrypoints.websecure.http.tls.domains[0].sans=*.jmartins.dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- --<span class=l>log.level=INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>CF_DNS_API_TOKEN=[REDACTED]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pihole</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>service_healthy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>proxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>service_started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jellyfin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>lscr.io/linuxserver/jellyfin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>jellyfin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=l>service:wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PUID=${PUID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PGID=${PGID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=${TZ}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>JELLYFIN_PublishedServerUrl=jellyfin.jmartins.dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/jellyfin:/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${MOVIE_BACKUPS_DIR}:/data/movie_backups</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>devices</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/dev/dri:/dev/dri</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pihole</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>service_healthy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ntfy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>binwiederhier/ntfy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>ntfy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>serve</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=${TZ}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NTFY_BASE_URL=https://ntfy.jmartins.dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NTFY_AUTH_DEFAULT_ACCESS=deny-all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NTFY_BEHIND_PROXY=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NTFY_ENABLE_LOGIN=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>${PUID}:${PGID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/ntfy_cache:/var/lib/ntfy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/ntfy_config:/etc/ntfy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;CMD-SHELL&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;wget -q --tries=1 http://localhost:80/v1/health -O - | grep -Eo &#39;\&#34;healthy\&#34;\\s*:\\s*true&#39; || exit 1&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>60s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class=l>40s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.enable=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.ntfy.entrypoints=websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.ntfy.rule=Host(`ntfy.jmartins.dev`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.ntfy.tls.certresolver=letsencrypt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.routers.ntfy.service=ntfy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.ntfy.loadbalancer.server.scheme=http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik.http.services.ntfy.loadbalancer.server.port=80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker-stack-network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>internal</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>traefik-internal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span></span></span></code></pre></div></div><p>The corresponding <code>.env</code> file:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>### .ENV FILE ###</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ======== user ========</span>
</span></span><span class=line><span class=cl><span class=nv>PUID</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=nv>PGID</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=nv>TZ</span><span class=o>=</span>Australia/Sydney
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ======== directories ========</span>
</span></span><span class=line><span class=cl><span class=nv>CONFIG_DIR</span><span class=o>=</span>/home/jmartins/docker-stack/configs
</span></span><span class=line><span class=cl><span class=nv>MOVIE_BACKUPS_DIR</span><span class=o>=</span>/mnt/media/movie_backups
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ======== network ========</span>
</span></span><span class=line><span class=cl><span class=nv>WIREGUARD_PORT</span><span class=o>=</span><span class=m>51820</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ======== service ports ========</span>
</span></span><span class=line><span class=cl><span class=nv>PIHOLE_WEBUI_PORT</span><span class=o>=</span><span class=m>9000</span>
</span></span><span class=line><span class=cl><span class=nv>PIHOLE_PASSWORD</span><span class=o>=</span>your_pihole_password
</span></span><span class=line><span class=cl><span class=nv>JELLYFIN_WEBUI_HTTP_PORT</span><span class=o>=</span><span class=m>8096</span></span></span></code></pre></div></div><p>You&rsquo;ll notice that Jellyfin&rsquo;s HTTP port is exposed directly on the WireGuard container in addition to being routed
through Traefik on 443. This is for Jellyfin&rsquo;s mobile apps, which can connect directly over the tunnel using the raw
HTTP port without going through the reverse proxy.</p><p>Two Docker networks are at play here. The <code>default</code> network is where most services live. The <code>internal</code> network exists
solely for Traefik to communicate with the Docker Socket Proxy — its <code>internal: true</code> flag prevents any container on it
from accessing the internet, limiting the blast radius if the proxy were compromised. The WireGuard container connects
to both networks, bridging them. Docker handles IP assignment and DNS resolution for container hostnames automatically,
so services can reference each other by name (e.g. Traefik reaches the proxy at <code>tcp://proxy:2375</code>) without needing
hardcoded addresses.</p><h2 class="relative group">Connecting from the Outside<div id=connecting-from-the-outside class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#connecting-from-the-outside aria-label=Anchor>#</a></span></h2><p>With the stack running, it&rsquo;s time to connect a device. The Linuxserver.io WireGuard image generates peer configurations
in <code>/config/peer_laptop/</code>, <code>/config/peer_phone/</code>, and so on. Each folder contains a <code>peer_&lt;name>.conf</code> file and a QR
code PNG that you can scan with the WireGuard mobile app.</p><p>A generated peer configuration looks something like this:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Interface]</span>
</span></span><span class=line><span class=cl><span class=na>Address</span> <span class=o>=</span> <span class=s>10.0.2.2/32</span>
</span></span><span class=line><span class=cl><span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>[REDACTED]</span>
</span></span><span class=line><span class=cl><span class=na>ListenPort</span> <span class=o>=</span> <span class=s>51820</span>
</span></span><span class=line><span class=cl><span class=na>DNS</span> <span class=o>=</span> <span class=s>10.0.2.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Peer]</span>
</span></span><span class=line><span class=cl><span class=na>PublicKey</span> <span class=o>=</span> <span class=s>[REDACTED]</span>
</span></span><span class=line><span class=cl><span class=na>PresharedKey</span> <span class=o>=</span> <span class=s>[REDACTED]</span>
</span></span><span class=line><span class=cl><span class=na>Endpoint</span> <span class=o>=</span> <span class=s>wireguard.example.com:51820</span>
</span></span><span class=line><span class=cl><span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>0.0.0.0/0</span></span></span></code></pre></div></div><p>The key fields: <code>DNS = 10.0.2.1</code> points to PiHole on the tunnel, and <code>AllowedIPs = 0.0.0.0/0</code> routes all traffic
through the VPN. Import this on your device, connect, and let&rsquo;s verify everything works.</p><p>From the connected laptop:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl https://am.i.mullvad.net/connected
</span></span><span class=line><span class=cl>You are connected to Mullvad <span class=o>(</span>server au14-wireguard<span class=o>)</span>. Your IP address is 89.44.10.183
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ dig +short jellyfin.jmartins.dev @10.0.2.1
</span></span><span class=line><span class=cl>10.0.2.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ curl -sI https://jellyfin.jmartins.dev <span class=p>|</span> head -5
</span></span><span class=line><span class=cl>HTTP/2 <span class=m>200</span>
</span></span><span class=line><span class=cl>content-type: text/html<span class=p>;</span> <span class=nv>charset</span><span class=o>=</span>utf-8
</span></span><span class=line><span class=cl>x-response-time-ms: <span class=m>12</span>
</span></span><span class=line><span class=cl>server: Kestrel
</span></span><span class=line><span class=cl>date: Sun, <span class=m>23</span> Feb <span class=m>2026</span> 10:00:00 GMT</span></span></code></pre></div></div><p>The first command confirms our traffic exits through Mullvad — same as in the previous article, but now from a remote
device rather than from inside the container. The second shows that PiHole resolves <code>jellyfin.jmartins.dev</code> to
<code>10.0.2.1</code>, the WireGuard tunnel address. The third confirms Traefik is routing the HTTPS request to Jellyfin and
serving a valid certificate.</p><p>We can also verify the WireGuard container is running both interfaces by <code>exec</code><em>ing</em> into it:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@wireguard:/# wg show
</span></span><span class=line><span class=cl>interface: wg0
</span></span><span class=line><span class=cl>  public key: <span class=o>[</span>REDACTED<span class=o>]</span>
</span></span><span class=line><span class=cl>  private key: <span class=o>(</span>hidden<span class=o>)</span>
</span></span><span class=line><span class=cl>  listening port: <span class=m>51820</span>
</span></span><span class=line><span class=cl>  fwmark: 0xca6c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>peer: <span class=o>[</span>REDACTED<span class=o>]</span>
</span></span><span class=line><span class=cl>  endpoint: 203.0.113.45:51820
</span></span><span class=line><span class=cl>  allowed ips: 10.0.2.2/32
</span></span><span class=line><span class=cl>  latest handshake: <span class=m>42</span> seconds ago
</span></span><span class=line><span class=cl>  transfer: 156.78 MiB received, 1.23 GiB sent
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>interface: wg1
</span></span><span class=line><span class=cl>  public key: <span class=o>[</span>REDACTED<span class=o>]</span>
</span></span><span class=line><span class=cl>  private key: <span class=o>(</span>hidden<span class=o>)</span>
</span></span><span class=line><span class=cl>  listening port: <span class=m>41983</span>
</span></span><span class=line><span class=cl>  fwmark: 0xca6c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>peer: <span class=o>[</span>REDACTED<span class=o>]</span>
</span></span><span class=line><span class=cl>  endpoint: 89.44.10.178:51820
</span></span><span class=line><span class=cl>  allowed ips: 0.0.0.0/0
</span></span><span class=line><span class=cl>  latest handshake: <span class=m>1</span> minute, <span class=m>12</span> seconds ago
</span></span><span class=line><span class=cl>  transfer: 2.45 GiB received, 892.34 MiB sent</span></span></code></pre></div></div><p><code>wg0</code> is the server interface with our laptop connected as a peer. <code>wg1</code> is the Mullvad client tunnel. Both are up,
both are transferring data, and the <code>fwmark</code> on both matches our kill switch exemption value of <code>0xca6c</code>.</p><h2 class="relative group">Conclusion<div id=conclusion class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#conclusion aria-label=Anchor>#</a></span></h2><p>What started in the <a href=/posts/wireguard-docker-killswitch/>previous article</a> as a single VPN client container with a kill
switch has evolved into a proper remote access stack. The WireGuard container now sits at the centre of the network,
simultaneously serving as a VPN client to Mullvad and a VPN server for remote devices. PiHole provides ad-blocking DNS
for every connected device, with a dnsmasq trick that routes service subdomains back through the WireGuard tunnel to
Traefik. Traefik handles HTTPS termination with a Let&rsquo;s Encrypt wildcard certificate obtained via DNS challenge, routing
requests to the correct service without any of them being directly exposed to the internet.</p><p>The stack fails closed — if the Mullvad connection drops, the kill switch blocks all outbound traffic for services
sharing the WireGuard network. If the WireGuard configuration fails to parse, the iptables rules from the startup
script are already in place. Services that need to maintain outbound connectivity regardless of VPN state, such as
notification and monitoring services, can be placed on their own Docker network to bypass the kill switch while
remaining accessible to remote clients through Traefik.</p><p>Every device connecting through the VPN gets ad blocking, encrypted DNS, and access to self-hosted services, all
through a single WireGuard connection. Adding a new service is a matter of defining the container with
<code>network_mode: service:wireguard</code> (or its own network, depending on the use case), adding Traefik labels for routing,
and exposing the port on the WireGuard container. PiHole&rsquo;s wildcard dnsmasq rule handles DNS automatically. No firewall
changes, no certificate requests, no client-side configuration.</p><hr><h2 class="relative group">Changelog<div id=changelog class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#changelog aria-label=Anchor>#</a></span></h2><ul><li><strong>2026-02-26</strong>: Updated the startup script to automatically patch <code>wg0.conf</code> with custom <code>PostUp</code> and <code>FwMark</code>
directives, eliminating the need to manually edit the generated config. Added <code>eth0</code> masquerade rule to the server&rsquo;s
<code>PostUp</code> for LAN access from peers. Added tolerant route additions for container restarts. Added conditional DNS
forwarding (<code>server=/proxy/127.0.0.11</code>) to PiHole&rsquo;s dnsmasq configuration so Traefik can resolve the Docker Socket
Proxy hostname after <code>wg-quick</code> overwrites <code>/etc/resolv.conf</code>. Added Traefik dashboard labels to the full compose
example.</li><li><strong>2026-02-23</strong>: Initial publication.</li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://docs.docker.com/reference/compose-file/services/#network_mode target=_blank rel=noreferrer>Docker Compose <code>network_mode</code> docs</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://www.linuxserver.io/blog/routing-docker-host-and-container-traffic-through-wireguard target=_blank rel=noreferrer>Linuxserver.io WireGuard guide</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://www.linuxserver.io/blog/2019-09-14-customizing-our-containers target=_blank rel=noreferrer>Linuxserver.io Custom Scripts</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://www.rfc-editor.org/rfc/rfc1918 target=_blank rel=noreferrer>RFC 1918 — Address Allocation for Private Internets</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://pi-hole.net/ target=_blank rel=noreferrer>Pi-hole — Network-wide ad blocking</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://traefik.io/traefik/ target=_blank rel=noreferrer>Traefik — Cloud Native Application Proxy</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p><a href=https://github.com/Tecnativa/docker-socket-proxy target=_blank rel=noreferrer>Tecnativa Docker Socket Proxy</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8><p><a href=https://letsencrypt.org/docs/challenge-types/#dns-01-challenge target=_blank rel=noreferrer>Let&rsquo;s Encrypt DNS-01 Challenge</a>&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:9><p><a href=https://ntfy.sh/ target=_blank rel=noreferrer>ntfy — Push notifications</a>&#160;<a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full me-4" width=96 height=96 alt="João M. Martins" src=/img/profile_hu_3f964613d62015e2.jpg data-zoom-src=/img/profile_hu_d3112e166403ddcd.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">João M. Martins</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Writing Python, Rust, JavaScript, focusing on backend systems for machine learning solutions.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/joaommartins target=_blank aria-label=Github title=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://codeberg.org/joaommartins target=_blank aria-label=Codeberg title=Codeberg rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg fill="currentColor" viewBox="0 0 24 24" role="img"><path d="M11.955.49A12 12 0 000 12.49a12 12 0 001.832 6.373L11.838 5.928a.187.14.0 01.324.0l10.006 12.935A12 12 0 0024 12.49a12 12 0 00-12-12 12 12 0 00-.045.0zm.375 6.467 4.416 16.553a12 12 0 005.137-4.213z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/joaommartins target=_blank aria-label=Linkedin title=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:contact@jmartins.dev target=_blank aria-label=Email title=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a></div></div></div></div><div class=mb-10></div></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/wireguard-docker-killswitch/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Routing Docker Containers Through a WireGuard VPN Container with Kill Switch
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-07-18T14:11:37+00:00>18 July 2025</time>
</span></span><span class="flex flex-col items-end"></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">© All rights reserved.</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://jmartins.dev/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>