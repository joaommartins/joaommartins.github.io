<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>Routing Docker Containers Through a WireGuard VPN Container with Kill Switch &#183; Learn Something New</title><meta name=title content="Routing Docker Containers Through a WireGuard VPN Container with Kill Switch &#183; Learn Something New"><meta name=description content="How to route your docker containers' traffic through a WireGuard container, with a kill switch."><meta name=keywords content="Docker,WireGuard,VPN,"><link rel=canonical href=https://jmartins.dev/posts/wireguard-docker-killswitch/><link type=text/css rel=stylesheet href=/css/main.bundle.min.d13877274e9cdbfb1df6b7cbc57e88481b985c7e15d542375cdb42c7a557a9d79717d10a26bc0a8186429f317a674299682aac2b1a8593e9083eea31f7ee708c.css integrity="sha512-0Th3J06c2/sd9rfLxX6ISBuYXH4V1UI3XNtCx6VXqdeXF9EKJrwKgYZCnzF6Z0KZaCqsKxqFk+kIPuox9+5wjA=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.b4a150efe91e7637ae9e43db58573e9edc22632d31d0c46de1d479f673d6779f7e96d2bc832d01bf9002bbf1ef2014843d4176c9735c40d5e7605f0a63266eac.js integrity="sha512-tKFQ7+kedjeunkPbWFc+ntwiYy0x0MRt4dR59nPWd59+ltK8gy0Bv5ACu/HvIBSEPUF2yXNcQNXnYF8KYyZurA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://jmartins.dev/posts/wireguard-docker-killswitch/"><meta property="og:site_name" content="Learn Something New"><meta property="og:title" content="Routing Docker Containers Through a WireGuard VPN Container with Kill Switch"><meta property="og:description" content="How to route your docker containers' traffic through a WireGuard container, with a kill switch."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-18T14:11:37+00:00"><meta property="article:modified_time" content="2025-07-18T14:11:37+00:00"><meta property="article:tag" content="Docker"><meta property="article:tag" content="WireGuard"><meta property="article:tag" content="VPN"><meta name=twitter:card content="summary"><meta name=twitter:title content="Routing Docker Containers Through a WireGuard VPN Container with Kill Switch"><meta name=twitter:description content="How to route your docker containers' traffic through a WireGuard container, with a kill switch."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"Routing Docker Containers Through a WireGuard VPN Container with Kill Switch","headline":"Routing Docker Containers Through a WireGuard VPN Container with Kill Switch","description":"How to route your docker containers\u0027 traffic through a WireGuard container, with a kill switch.","inLanguage":"en","url":"https:\/\/jmartins.dev\/posts\/wireguard-docker-killswitch\/","author":{"@type":"Person","name":"João M. Martins"},"copyrightYear":"2025","dateCreated":"2025-07-18T14:11:37\u002b00:00","datePublished":"2025-07-18T14:11:37\u002b00:00","dateModified":"2025-07-18T14:11:37\u002b00:00","keywords":["Docker","WireGuard","VPN"],"mainEntityOfPage":"true","wordCount":"2910"}]</script><meta name=author content="João M. Martins"><link href=https://github.com/joaommartins rel=me><link href=https://codeberg.org/joaommartins rel=me><link href=https://linkedin.com/in/joaommartins rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Learn Something New</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>About</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Blog</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>About</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Blog</p></a></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Routing Docker Containers Through a WireGuard VPN Container with Kill Switch</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-07-18T14:11:37+00:00>18 July 2025</time><span class="px-2 text-primary-500">&#183;</span><span>2910 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">14 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#containers>Containers</a></li><li><a href=#wireguard>WireGuard</a></li><li><a href=#linuxserverio>Linuxserver.io</a></li><li><a href=#vpn>VPN</a></li><li><a href=#putting-it-all-together>Putting it all together</a></li><li><a href=#wireguard-kill-switch>WireGuard Kill Switch</a><ul><li><a href=#note-on-dns-resolution-vs-outbound-traffic>Note on DNS resolution vs outbound traffic</a></li></ul></li><li><a href=#vpn-consumers>VPN consumers</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#containers>Containers</a></li><li><a href=#wireguard>WireGuard</a></li><li><a href=#linuxserverio>Linuxserver.io</a></li><li><a href=#vpn>VPN</a></li><li><a href=#putting-it-all-together>Putting it all together</a></li><li><a href=#wireguard-kill-switch>WireGuard Kill Switch</a><ul><li><a href=#note-on-dns-resolution-vs-outbound-traffic>Note on DNS resolution vs outbound traffic</a></li></ul></li><li><a href=#vpn-consumers>VPN consumers</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})(),function(){var t,e=$("#TableOfContents");if(e.length>0){t=$(window);function n(){var s,o=t.scrollTop(),i=$(".anchor"),n="";if(i.each(function(e,t){t=$(t),t.offset().top-$(window).height()/3<=o&&(n=decodeURIComponent(t.attr("id")))}),s=e.find("a.active"),s.length==1&&s.eq(0).attr("href")=="#"+n)return!0;s.each(function(e,t){$(t).removeClass("active").siblings("ul").hide()}),e.find('a[href="#'+n+'"]').addClass("active"),e.find('a[href="#'+n+'"]').parentsUntil("#TableOfContents").each(function(e,t){$(t).children("a").parents("ul").show()})}t.on("scroll",n),$(document).ready(function(){e.find("a").parent("li").find("ul").hide(),n()})}}()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><blockquote><p><strong>TL;DR</strong> If you don’t feel like reading my ramblings, the Github repository with the final state of the
<code>docker-compose.yaml</code> file, as well as the necessary configuration files can be found
<a href=https://github.com/joaommartins/wireguard-network-stack target=_blank>here</a>.</p></blockquote><p>If you&rsquo;re anything like me, you like to tinker with everything technology-related. You&rsquo;re also weary of fingerprinting
and tracking of your online habits, and would like to set up a way of routing your self-hosted services like PiHole
through a VPN, while keeping everything easily configurable and transferable. If you&rsquo;re nodding your head right now,
you&rsquo;ve come to the right place.</p><h2 class="relative group">Containers<div id=containers class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#containers aria-label=Anchor>#</a></span></h2><p>Containers, in this context, are used as a reference to any containerization platform that performs OS-level
virtualization through multiple userspace container instances. The benefit of using containers is that we are able
to encapsulate the software and its dependencies into a single package that can then be deployed in different
environments. Configuration of these &ldquo;containers&rdquo; should be done through files, making a deployment replicable and
transferable across different environments.</p><h2 class="relative group">WireGuard<div id=wireguard class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#wireguard aria-label=Anchor>#</a></span></h2><p>Like the older OpenVPN protocol, WireGuard is a protocol and software implementation for establishing virtual private
networks (VPNs). It excels in its lower overhead relative to older protocols, its high performance and its easy
configuration. The protocol was released in the Linux 5.6 kernel, which we will be making use of its kernel modules
inside a container by exposing <code>/lib/modules</code>. The standard software implementation of the WireGuard protocol is also
called WireGuard, which may cause some confusion, but all we need to know is that it the application that allows us to
interact with the wireguard kernel module. Most of the time we&rsquo;ll be using <code>wg-quick</code>, the utility to establish and
stop WireGuard VPN connections.</p><h2 class="relative group">Linuxserver.io<div id=linuxserverio class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#linuxserverio aria-label=Anchor>#</a></span></h2><p>Linuxserver.io is a community and community-maintained list of docker container images who follow a unified
best-practices approach to their container images, while maintaining small container sizes and some helpful added-on
functionality that we will be making use of for implementing the kill switch. They maintain a WireGuard (userspace
utilities) image that we will use as the outbound VPN container through which all other containers will connect to the
internet. Using Linuxserver.io&rsquo;s <code>/custom-cont-init.d</code> folder we can add a startup script that will be run before the
VPN connection is made. The GitHub image repository can be found <a href=https://github.com/linuxserver/docker-wireguard target=_blank>here</a>.</p><h2 class="relative group">VPN<div id=vpn class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#vpn aria-label=Anchor>#</a></span></h2><p>It&rsquo;s now time to set up our own VPN client with a correctly configured kill switch and add some other images to use it.
The first step is to get your own VPN provider, I have used Mullvad VPN for a few years as my VPN provider of choice and
have never had any issues with them. They run a no-log VPN service, their clients are open source, and they helped fund
WireGuard&rsquo;s development, so it&rsquo;s a pretty easy choice for me. Most importantly, in this case, is that you can generate a
WireGuard client configuration that you can then use as the configuration for your Linuxserver.io WireGuard container.</p><h2 class="relative group">Putting it all together<div id=putting-it-all-together class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#putting-it-all-together aria-label=Anchor>#</a></span></h2><p>OK, we&rsquo;re ready to create our stack. Following Linuxserver.io WireGuard container&rsquo;s instructions, we can generate our
first docker-compose.yaml.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>### DOCKER-COMPOSE.YAML FILE ###</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>wireguard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>lscr.io/linuxserver/wireguard:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cap_add</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET_ADMIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SYS_MODULE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PUID=${PUID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PGID=${PGID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=${TZ}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/wireguard:/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/wireguard_startup:/custom-cont-init.d:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/lib/modules:/lib/modules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sysctls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>net.ipv4.conf.all.src_valid_mark=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span></code></pre></div><p>The variables in the docker-compose.yaml file are saved in the <code>.env</code> file, which get automatically used by
docker-compose:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>### .ENV FILE ###</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ======== user ========</span>
</span></span><span class=line><span class=cl><span class=nv>PUID</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=nv>PGID</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=nv>TZ</span><span class=o>=</span>Australia/Sydney
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ======== directories ========</span>
</span></span><span class=line><span class=cl><span class=nv>CONFIG_DIR</span><span class=o>=</span>/home/jmartins/wireguard-stack/configs
</span></span></code></pre></div><p>In order to use WireGuard we need to drop a WireGuard configuration file in the container&rsquo;s <code>/config</code> folder that we map
to our <code>${CONFIG_DIR}/wireguard</code> folder. Generating this file on Mullvad&rsquo;s website is fairly easy, and in this case we&rsquo;re
only using an IPv4-only configuration since we want to manually control the ports available from outside the host. The
generated configuration should look something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-TOML data-lang=TOML><span class=line><span class=cl><span class=p>[</span><span class=nx>Interface</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>PrivateKey</span> <span class=p>=</span> <span class=p>[</span><span class=nx>REDACTED</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>Address</span> <span class=p>=</span> <span class=mf>10.64</span><span class=p>.</span><span class=mf>114.74</span><span class=err>/</span><span class=mi>32</span>
</span></span><span class=line><span class=cl><span class=nx>DNS</span> <span class=p>=</span> <span class=mf>10.64</span><span class=p>.</span><span class=mf>0.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>Peer</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>PublicKey</span> <span class=p>=</span> <span class=nx>a6oniBujlUXqOmv5Hst0v8xCqidy7O4JcN8Q6YRM5Hk</span><span class=p>=</span>
</span></span><span class=line><span class=cl><span class=nx>AllowedIPs</span> <span class=p>=</span> <span class=mf>0.0</span><span class=p>.</span><span class=mf>0.0</span><span class=err>/</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nx>Endpoint</span> <span class=p>=</span> <span class=mf>89.44</span><span class=p>.</span><span class=mf>10.178</span><span class=err>:</span><span class=mi>51820</span>
</span></span></code></pre></div><p>If we run the <code>docker-compose up -d</code> command, the default network will now be created, along with the docker container. We can
test the spun up container by executing <code>docker exec -it wireguard /bin/bash</code> to get access to a bash session inside the
running container. Here, we can run regular network tests like <code>curl</code><em>ing</em> Mullvad&rsquo;s connection check URLand <code>ping</code><em>ing</em>
IP addresses:</p><pre tabindex=0><code>root@wireguard:/# curl https://am.i.mullvad.net/connected
You are connected to Mullvad (server au14-wireguard). Your IP address is 89.44.10.183

root@wireguard:/# ping 1.1.1.1
PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.
64 bytes from 1.1.1.1: icmp_seq=1 ttl=58 time=3.84 ms
64 bytes from 1.1.1.1: icmp_seq=2 ttl=58 time=3.82 ms
64 bytes from 1.1.1.1: icmp_seq=3 ttl=58 time=3.29 ms
^C
--- 1.1.1.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2004ms
rtt min/avg/max/mdev = 3.293/3.651/3.838/0.253 ms
</code></pre><p>You are now ready to start routing connections through this container by setting their network mode as
<code>"service:wireguard"</code>. But before we get to that, lets take care of the network kill switch, which will prevent requests
to flow outside the network if for some reason the VPN connection is dropped.</p><h2 class="relative group">WireGuard Kill Switch<div id=wireguard-kill-switch class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#wireguard-kill-switch aria-label=Anchor>#</a></span></h2><p>Generating the wg0.conf file on Mullvad&rsquo;s website allows us to add a kill switch to the wireguard configuration. These
are nothing but shell commands that run PostUp and PreDown, <code>up</code> and <code>down</code> referring to <code>wg-quick</code>&rsquo;s verbs for starting
and stopping the VPN client connection.</p><figure><img class="my-0 rounded-md" srcset="/posts/wireguard-docker-killswitch/mullvad_wireguard_killswitch_hu_988ae223938b79e.png 330w,
/posts/wireguard-docker-killswitch/mullvad_wireguard_killswitch_hu_ba94eece5d729705.png 660w,
/posts/wireguard-docker-killswitch/mullvad_wireguard_killswitch_hu_ddf1dc04d84ba5b.png 1024w,
/posts/wireguard-docker-killswitch/mullvad_wireguard_killswitch_hu_6e950e9834793011.png 2x" src=/posts/wireguard-docker-killswitch/mullvad_wireguard_killswitch_hu_ba94eece5d729705.png data-zoom-src=/posts/wireguard-docker-killswitch/mullvad_wireguard_killswitch_hu_6e950e9834793011.png alt="Mullvad WireGuard configuration generation webpage"></figure><p>Creating a WireGuard configuration with a kill switch yields the following file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>Interface<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>PrivateKey</span> <span class=o>=</span> <span class=o>[</span>REDACTED<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Address</span> <span class=o>=</span> 10.64.23.84/32,fc00:bbbb:bbbb:bb01::1:1753/128
</span></span><span class=line><span class=cl><span class=nv>DNS</span> <span class=o>=</span> 10.64.0.1
</span></span><span class=line><span class=cl><span class=nv>PostUp</span> <span class=o>=</span> iptables -I OUTPUT ! -o %i -m mark ! --mark <span class=k>$(</span>wg show %i fwmark<span class=k>)</span> -m addrtype ! --dst-type LOCAL -j REJECT <span class=o>&amp;&amp;</span> ip6tables -I OUTPUT ! -o %i -m mark ! --mark <span class=k>$(</span>wg show %i fwmark<span class=k>)</span> -m addrtype ! --dst-type LOCAL -j REJECT
</span></span><span class=line><span class=cl><span class=nv>PreDown</span> <span class=o>=</span> iptables -D OUTPUT ! -o %i -m mark ! --mark <span class=k>$(</span>wg show %i fwmark<span class=k>)</span> -m addrtype ! --dst-type LOCAL -j REJECT <span class=o>&amp;&amp;</span> ip6tables -D OUTPUT ! -o %i -m mark ! --mark <span class=k>$(</span>wg show %i fwmark<span class=k>)</span> -m addrtype ! --dst-type LOCAL -j REJECT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Peer<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>PublicKey</span> <span class=o>=</span> <span class=nv>pu22RCPeJCeiDIE7a1XtWvmv3BdgPp8ugF6AyntW8xU</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>AllowedIPs</span> <span class=o>=</span> 0.0.0.0/0,::0/0
</span></span><span class=line><span class=cl><span class=nv>Endpoint</span> <span class=o>=</span> 89.44.10.114:51820
</span></span></code></pre></div><p>The kill switch commands consist of <code>iptables</code> rules blocking all outbound traffic in the container and allowing only
traffic to flow through the wireguard network adapter.</p><p>Using the downloaded configuration file, we can see that stopping the connection will remove the iptables rules,
allowing traffic to flow out:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@wireguard:/# curl https://am.i.mullvad.net/connected
</span></span><span class=line><span class=cl>You are connected to Mullvad <span class=o>(</span>server au14-wireguard<span class=o>)</span>. Your IP address is 89.44.10.183
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@wireguard:/# ping 1.1.1.1
</span></span><span class=line><span class=cl>PING 1.1.1.1 <span class=o>(</span>1.1.1.1<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 1.1.1.1: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>58</span> <span class=nv>time</span><span class=o>=</span>3.28 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 1.1.1.1: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>58</span> <span class=nv>time</span><span class=o>=</span>11.6 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 1.1.1.1: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>3</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>58</span> <span class=nv>time</span><span class=o>=</span>4.08 ms
</span></span><span class=line><span class=cl>^C
</span></span><span class=line><span class=cl>--- 1.1.1.1 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>3</span> packets transmitted, <span class=m>3</span> received, 0% packet loss, <span class=nb>time</span> 2004ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 3.278/6.304/11.559/3.730 ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@wireguard:/# wg-quick down wg0
</span></span><span class=line><span class=cl>Warning: <span class=sb>`</span>/config/wg0.conf<span class=err>&#39;</span> is world accessible
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] iptables -D OUTPUT ! -o wg0 -m mark ! --mark $(wg show wg0 fwmark) -m addrtype ! --dst-type LOCAL -j REJECT &amp;&amp; ip6tables -D OUTPUT ! -o wg0 -m mark ! --mark $(wg show wg0 fwmark) -m addrtype ! --dst-type LOCAL -j REJECT</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip -4 rule delete table 51820</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip -4 rule delete table main suppress_prefixlength 0</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip -6 rule delete table 51820</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip -6 rule delete table main suppress_prefixlength 0</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip link delete dev wg0</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] resolvconf -d wg0 -f</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] iptables-restore -n</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip6tables-restore -n</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@wireguard:/# curl https://am.i.mullvad.net/connected
</span></span><span class=line><span class=cl>You are not connected to Mullvad. Your IP address is 161.8.193.91
</span></span><span class=line><span class=cl>root@wireguard:/# ping 1.1.1.1
</span></span><span class=line><span class=cl>PING 1.1.1.1 <span class=o>(</span>1.1.1.1<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 1.1.1.1: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>57</span> <span class=nv>time</span><span class=o>=</span>2.66 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 1.1.1.1: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>57</span> <span class=nv>time</span><span class=o>=</span>3.87 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 1.1.1.1: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>3</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>57</span> <span class=nv>time</span><span class=o>=</span>3.30 ms
</span></span><span class=line><span class=cl>^C
</span></span><span class=line><span class=cl>--- 1.1.1.1 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>3</span> packets transmitted, <span class=m>3</span> received, 0% packet loss, <span class=nb>time</span> 2003ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 2.657/3.276/3.872/0.496 ms
</span></span></code></pre></div><blockquote><h3 class="relative group">Note on DNS resolution vs outbound traffic<div id=note-on-dns-resolution-vs-outbound-traffic class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#note-on-dns-resolution-vs-outbound-traffic aria-label=Anchor>#</a></span></h3><p>There is a possibility that you may confuse lack of DNS resolution with blocked outbound traffic if your IP block
overlaps with your container network subnet. This is unlikely to happen and that would mean that DNS resolution was
blocked regardless of iptables rules, but it also means that you may be mistaken on the state of your container network
rules. This could, for example, allow through traffic that does not depend on DNS, like say a peer-to-peer connection.</p></blockquote><p>The solution is then to remove the PreDown directive, leading to an outbound blocked connection state whenever the
connection is brought down.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@wireguard:/# wg-quick down wg0
</span></span><span class=line><span class=cl>Warning: <span class=sb>`</span>/config/wg0.conf<span class=err>&#39;</span> is world accessible
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip -4 rule delete table 51820</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip -4 rule delete table main suppress_prefixlength 0</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip -6 rule delete table 51820</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip -6 rule delete table main suppress_prefixlength 0</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip link delete dev wg0</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] resolvconf -d wg0 -f</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] iptables-restore -n</span>
</span></span><span class=line><span class=cl><span class=o>[</span><span class=c1>#] ip6tables-restore -n</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@wireguard:/# curl https://am.i.mullvad.net/connected
</span></span><span class=line><span class=cl>curl: <span class=o>(</span>6<span class=o>)</span> Could not resolve host: am.i.mullvad.net
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@wireguard:/# ping 1.1.1.1
</span></span><span class=line><span class=cl>PING 1.1.1.1 <span class=o>(</span>1.1.1.1<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl>From 10.0.0.2 <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> Destination Port Unreachable
</span></span><span class=line><span class=cl>ping: sendmsg: Operation not permitted
</span></span><span class=line><span class=cl>From 10.0.0.2 <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> Destination Port Unreachable
</span></span><span class=line><span class=cl>ping: sendmsg: Operation not permitted
</span></span><span class=line><span class=cl>From 10.0.0.2 <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>3</span> Destination Port Unreachable
</span></span><span class=line><span class=cl>ping: sendmsg: Operation not permitted
</span></span><span class=line><span class=cl>^C
</span></span><span class=line><span class=cl>--- 1.1.1.1 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>3</span> packets transmitted, <span class=m>0</span> received, +3 errors, 100% packet loss, <span class=nb>time</span> 2032ms
</span></span></code></pre></div><p>A less curious/paranoid person would at this point be happy with the kill switch functionality. However, I am neither of
those. Since the kill switch depends on a successful parsing of the wireguard configuration file, an issue presents itself
with the way the container handles failure. In short, if there are any issues parsing the configuration file, the
container will not connect to the VPN server and continue allowing outbound network calls to flow through. <em>Silently.</em></p><p>In a borrowed term from mechanical engineering into application/network security, this is a case of <em>fail open</em>,
where a failure on startup will lead to a permissive state. If we purposely create this error, we can see the issue.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>Interface<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>PrivateKey</span> <span class=o>=</span> <span class=o>[</span>REDACTED<span class=o>]</span>
</span></span><span class=line><span class=cl>Address  <span class=c1># This malformed configuration leads to an error</span>
</span></span><span class=line><span class=cl><span class=nv>DNS</span> <span class=o>=</span> 10.64.0.1
</span></span><span class=line><span class=cl><span class=nv>PostUp</span> <span class=o>=</span> iptables -I OUTPUT ! -o %i -m mark ! --mark <span class=k>$(</span>wg show %i fwmark<span class=k>)</span> -m addrtype ! --dst-type LOCAL -j REJECT <span class=o>&amp;&amp;</span> ip6tables -I OUTPUT ! -o %i -m mark ! --mark <span class=k>$(</span>wg show %i fwmark<span class=k>)</span> -m addrtype ! --dst-type LOCAL -j REJECT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Peer<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>PublicKey</span> <span class=o>=</span> <span class=nv>a6oniBujlUXqOmv5Hst0v8xCqidy7O4JcN8Q6YRM5Hk</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>AllowedIPs</span> <span class=o>=</span> 0.0.0.0/0
</span></span><span class=line><span class=cl><span class=nv>Endpoint</span> <span class=o>=</span> 89.44.10.178:51820
</span></span></code></pre></div><p>Docker log of the container startup:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>wireguard  <span class=p>|</span> Warning: <span class=sb>`</span>/config/wg0.conf<span class=err>&#39;</span> is world accessible
</span></span><span class=line><span class=cl>wireguard  <span class=p>|</span> <span class=o>[</span><span class=c1>#] ip link add wg0 type wireguard</span>
</span></span><span class=line><span class=cl>wireguard  <span class=p>|</span> <span class=o>[</span><span class=c1>#] wg setconf wg0 /dev/fd/63</span>
</span></span><span class=line><span class=cl>wireguard  <span class=p>|</span> <span class=o>[</span><span class=c1>#] ip -4 address add Address dev wg0</span>
</span></span><span class=line><span class=cl>wireguard  <span class=p>|</span> Error: inet prefix is expected rather than <span class=s2>&#34;Address&#34;</span>.
</span></span><span class=line><span class=cl>wireguard  <span class=p>|</span> <span class=o>[</span><span class=c1>#] ip link delete dev wg0</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>We can then see that we are able to make outbound requests from the container, as if we were connected and blocking
requests outside the VPN tunnel:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@wireguard:/# curl https://am.i.mullvad.net/connected
</span></span><span class=line><span class=cl>You are not connected to Mullvad. Your IP address is X.X.X.X
</span></span></code></pre></div><p>If we would like to make this a <em>fail close</em> system, a solution is to decouple the iptables outbound rules setting from
the WireGuard execution. Making use of the Linuxserver container addons we can add a script that will be run on
container startup and will block outbound connections the same way as PostUp does.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;**** IPTABLES BLOCK ****&#34;</span>
</span></span><span class=line><span class=cl>iptables -I OUTPUT ! -o wg0 -m mark ! --mark 0xca6c -m addrtype ! --dst-type LOCAL -j REJECT
</span></span><span class=line><span class=cl>ip6tables -I OUTPUT ! -o wg0 -m mark ! --mark 0xca6c -m addrtype ! --dst-type LOCAL -j REJECT
</span></span></code></pre></div><p><code>wg-quick</code> automatically adds a mark on all encrypted packets it sends<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, with the value of this mark being the port it
is configured to connect through. If you use the default 51820 port, then the iptables rules matching 0xca6c will work,
as this is the hexadecimal representation of decimal 51820. If you use any other port, then you must change this script
to the correct hexadecimal value, and if you forget to do this, no traffic will be allowed to flow outbound from the
container. Again, failing closed.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@wireguard:/# curl https://am.i.mullvad.net/connected
</span></span><span class=line><span class=cl>curl: <span class=o>(</span>6<span class=o>)</span> Could not resolve host: am.i.mullvad.net
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@wireguard:/# ping 1.1.1.1
</span></span><span class=line><span class=cl>PING 1.1.1.1 <span class=o>(</span>1.1.1.1<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl>From 10.0.0.2 <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> Destination Port Unreachable
</span></span><span class=line><span class=cl>ping: sendmsg: Operation not permitted
</span></span><span class=line><span class=cl>From 10.0.0.2 <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> Destination Port Unreachable
</span></span><span class=line><span class=cl>ping: sendmsg: Operation not permitted
</span></span><span class=line><span class=cl>From 10.0.0.2 <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>3</span> Destination Port Unreachable
</span></span><span class=line><span class=cl>ping: sendmsg: Operation not permitted
</span></span><span class=line><span class=cl>^C
</span></span><span class=line><span class=cl>--- 1.1.1.1 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>3</span> packets transmitted, <span class=m>0</span> received, +3 errors, 100% packet loss, <span class=nb>time</span> 2032ms
</span></span></code></pre></div><blockquote><p>Note: In the default Mullvad wireguard configuration, the packet mark is obtained by running <code>wg show %i fwmark</code>, where
<code>%i</code> is the wireguard interface name as expanded in <code>wg-quick</code><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. This won&rsquo;t work here, as the startup script
will run before the wireguard interface is created, and thus we instead hardcode the mark to <code>0xca6c</code> instead, ensuring
that, regardless of the wireguard connection state, only packets marked with <code>0xca6c</code> will be allowed to egress.</p></blockquote><h2 class="relative group">VPN consumers<div id=vpn-consumers class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#vpn-consumers aria-label=Anchor>#</a></span></h2><p>Now that we have the container ready and we&rsquo;re correctly stopping requests we don&rsquo;t want to proceed, we can configure
other containerised images that we will route through the VPN container exclusively. This will both route all their
network requests through the WireGuard container as well as make them subject to its outbound network rules containing
the kill switch. For this, we&rsquo;ll use <code>docker-compose</code>&rsquo;s <code>network_mode</code><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> option, as suggested in this
Linuxserver.io article<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>, allowing a container to make use of a different container&rsquo;s network
stack, in this case the WireGuard container.</p><p>As an example consumer application, we&rsquo;re using here the <code>thespeedtest-tracker</code>, which will periodically, every ten
minutes, run a speed test in its network interface and store the result. Since we&rsquo;re forcing the container to use the
<code>wireguard</code> container&rsquo;s network stack, its <code>iptables</code> rules will apply and all traffic will flow through the wireguard
interface.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>### DOCKER-COMPOSE.YAML FILE ###</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>wireguard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>lscr.io/linuxserver/wireguard:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cap_add</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET_ADMIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SYS_MODULE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PUID=${PUID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PGID=${PGID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=${TZ}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/wireguard:/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/wireguard_startup:/custom-cont-init.d:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/lib/modules:/lib/modules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>8080</span><span class=p>:</span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sysctls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>net.ipv4.conf.all.src_valid_mark=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=l>ping -c 1 1.1.1.1 || exit 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_interval</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>speedtest-tracker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>lscr.io/linuxserver/speedtest-tracker:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>speedtest-tracker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=l>service:wireguard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PUID=${PUID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PGID=${PGID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>TZ=${TZ}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>APP_KEY=${APP_KEY}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DB_CONNECTION=sqlite</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>SPEEDTEST_SCHEDULE=&#34;*/10 * * * *&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DISPLAY_TIMEZONE=${TZ}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${CONFIG_DIR}/speedtest-tracker:/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=l>curl -fSs http://localhost/api/healthcheck | jq -r .message || exit 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>wireguard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>service_healthy</span><span class=w>
</span></span></span></code></pre></div><p>As you may notice, since the network is managed by the <code>wireguard</code> container, in order to expose the port that
<code>speedtest-tracker</code> serves its web interface in, port 80, this port forward needs to be controlled on the <code>wireguard</code>
ports directive instead. Here, we&rsquo;ve decided to port forward that port to port 8080, which we&rsquo;ll use to access the
<code>speedtest-tracker</code> web UI.</p><p>Finally, like described on the linuxserver.io guide<sup id=fnref1:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>:</p><blockquote><p>But it doesn&rsquo;t end there. Even though the port is mapped, once the tunnel is up, it won&rsquo;t respond to any requests
coming from the host as it&rsquo;s configured to send all outgoing connections through the tunnel.</p></blockquote><p>This means we need to add the routing rules to allow the host to access the container&rsquo;s web interface. In the article,
this is done as part of the <code>wg-quick</code> configuration file, but since we are using a shell script to set the kill switch
rules, we can add the routing rules there as well. The following lines will allow the host to access the
<code>speedtest-tracker</code> web interface:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=nb>set</span> -e
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;**** Adding iptables rules ****&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>HOMENET</span><span class=o>=</span>192.168.0.0/16
</span></span><span class=line><span class=cl><span class=nv>HOMENET2</span><span class=o>=</span>10.0.0.0/8
</span></span><span class=line><span class=cl><span class=nv>HOMENET3</span><span class=o>=</span>172.16.0.0/12
</span></span><span class=line><span class=cl>iptables -I OUTPUT -d <span class=nv>$HOMENET</span> -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A OUTPUT -d <span class=nv>$HOMENET2</span> -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A OUTPUT -d <span class=nv>$HOMENET3</span> -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Kill switch</span>
</span></span><span class=line><span class=cl>iptables -A OUTPUT ! -o wg0 -m mark ! --mark 0xca6c -m addrtype ! --dst-type LOCAL -j REJECT
</span></span><span class=line><span class=cl>ip6tables -I OUTPUT ! -o wg0 -m mark ! --mark 0xca6c -m addrtype ! --dst-type LOCAL -j REJECT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;**** Successfully added iptables rules ****&#34;</span>
</span></span></code></pre></div><p>Here, the various <code>HOMENET</code>s are the local network IP ranges usually used in home networks, as defined in RFC-1918<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>.
We add the iptables rules to allow traffic to flow out to the local network, including the web UI of the <code>speedtest-tracker</code>
container, which is now accessible at <code>http://localhost:8080</code>.</p><h2 class="relative group">Conclusion<div id=conclusion class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#conclusion aria-label=Anchor>#</a></span></h2><p>In this article, we have seen how to set up a WireGuard VPN container that can be used as a kill switch for other
containers. We have also seen how to set up a consumer container that uses the WireGuard container&rsquo;s network stack and
how to expose its web interface to the host. The kill switch is implemented using iptables rules that block all
outbound traffic unless it is going through the WireGuard interface, and we have ensured that the system fails
closed by decoupling the kill switch from the WireGuard connection setup.</p><p>This was never intended to be a series of articles, but since it took me so long to finally write it down, my local wireguard
stack has evolved quite a bit, including running the WireGuard container as both a client and a server, allowing clients
to connect to it over the internet, routing their traffic through the Mullvad VPN connection and giving access to the
containers running on the host. Expect a follow-up article on this topic in the future.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://www.procustodibus.com/blog/2022/01/wg-quick-firewall-rules/ target=_blank>Wg-quick Default Firewall Rules</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://manpages.debian.org/unstable/wireguard-tools/wg-quick.8.en.html target=_blank>wg-quick manpage</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://docs.docker.com/reference/compose-file/services/#network_mode target=_blank>Docker compose <code>network_mode</code> docs</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://www.linuxserver.io/blog/routing-docker-host-and-container-traffic-through-wireguard#setting-up-a-container-to-use-the-wireguard-containers-network-s target=_blank>Linuxserver.io Wireguard guide</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=www.rfc-editor.org/rfc/rfc1918>RFC-1918</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="João M. Martins" src=/img/profile_hu_d575b69927f8e03e.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">João M. Martins</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Writing Python, Rust, JavaScript, focusing on backend systems for machine learning solutions.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/joaommartins target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://codeberg.org/joaommartins target=_blank aria-label=Codeberg rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg fill="currentColor" viewBox="0 0 24 24" role="img"><path d="M11.955.49A12 12 0 000 12.49a12 12 0 001.832 6.373L11.838 5.928a.187.14.0 01.324.0l10.006 12.935A12 12 0 0024 12.49a12 12 0 00-12-12 12 12 0 00-.045.0zm.375 6.467 4.416 16.553a12 12 0 005.137-4.213z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/joaommartins target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:contact@jmartins.dev target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a></div></div></div></div><div class=mb-10></div></div><script>var oid="views_posts/wireguard-docker-killswitch/index.md",oid_likes="likes_posts/wireguard-docker-killswitch/index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/dark-mode/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Gatsby, Lumen and Dark Mode</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2021-05-31T20:04:37+00:00>31 May 2021</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/wireguard-docker-vpn-server/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Running WireGuard as Client and Server in Docker with PiHole and Traefik</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2026-02-23T10:00:00+00:00>23 February 2026</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">© All rights reserved.</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://jmartins.dev/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>